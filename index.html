<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPKBIS Showcase Judge Login</title>
    <script src="https://cdn-tailwindcss.vercel.app/"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <!-- jsPDF Libraries for PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .view { display: none; }
        .view.active { display: block; }
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-overlay.active {
            display: flex;
        }
        .tab-active {
            border-color: #4f46e5;
            color: #4f46e5;
        }
        .online-indicator {
            height: 10px;
            width: 10px;
            background-color: #22c55e; /* green-500 */
            border-radius: 50%;
            display: inline-block;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }
        /* Style for draggable items */
        .presenter-item {
            cursor: grab;
            transition: background-color 0.2s;
        }
        .presenter-item:active {
            cursor: grabbing;
        }
        /* Judge sidebar styles */
        .sidebar-item {
            cursor: pointer;
            transition: background-color 0.1s;
        }
        .sidebar-item:hover {
            background-color: #eef2ff; /* indigo-50 */
        }
        .sidebar-item.active-card {
            background-color: #c7d2fe; /* indigo-300 */
            font-weight: 600;
        }
        /* Sticky sidebar for judge view */
        @media (min-width: 768px) {
            #judge-sidebar-wrapper {
                position: sticky;
                top: 100px; /* Adjust based on header height */
                max-height: calc(100vh - 120px);
                overflow-y: auto;
            }
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div id="app-container" class="container mx-auto p-4 md:p-8 max-w-7xl">

        <div id="login-view" class="view active">
            <div class="max-w-md mx-auto bg-white rounded-xl shadow-md overflow-hidden md:max-w-2xl mt-16">
                <div class="p-8">
                    <h1 class="text-3xl font-bold text-center text-gray-900 mb-2">PPKBIS Showcase Judge Login</h1>
                    <p class="text-center text-gray-500 mb-8">Select your role and session to continue</p>
                    <form id="login-form">
                        <div class="mb-6">
                            <label for="username" class="block mb-2 text-sm font-medium text-gray-900">Your Name (e.g., Judge 1)</label>
                            <input type="text" id="username" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5" placeholder="Enter your name" required>
                        </div>
                        <div class="mb-6">
                            <label for="role" class="block mb-2 text-sm font-medium text-gray-900">Select Role</label>
                            <select id="role" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5">
                                <option value="judge">Judge</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <div id="session-field" class="mb-6">
                            <label for="session" class="block mb-2 text-sm font-medium text-gray-900">Select Session</label>
                            <!-- UPDATED: New session list for Judge Login -->
                            <select id="session" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5">
                                <option value="Showcase 1 (Poster 1st Session)">Showcase 1 (Poster 1st Session)</option>
                                <option value="Showcase 2 (Oral 1st Session)">Showcase 2 (Oral 1st Session)</option>
                                <option value="Showcase 3 (Poster 2nd Session)">Showcase 3 (Poster 2nd Session)</option>
                                <option value="Showcase 4 (Oral 2nd Session)">Showcase 4 (Oral 2nd Session)</option>
                                <option value="Showcase 5 (Workshop)">Showcase 5 (Workshop)</option>
                            </select>
                        </div>
                        <div id="admin-password-field" class="mb-6" style="display: none;">
                            <label for="password" class="block mb-2 text-sm font-medium text-gray-900">Admin Password</label>
                            <input type="password" id="password" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5" placeholder="•••••••••">
                        </div>
                        <button type="submit" class="w-full text-white bg-indigo-600 hover:bg-indigo-700 focus:ring-4 focus:outline-none focus:ring-indigo-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center">Login</button>
                    </form>
                </div>
            </div>
        </div>

        <div id="admin-view" class="view">
            <header class="flex justify-between items-center mb-8">
                <h1 class="text-4xl font-bold text-gray-900">Admin Dashboard</h1>
                <button id="admin-logout" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Logout</button>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1 space-y-6">
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h2 class="text-2xl font-semibold mb-4">Add Presenter</h2>
                        <form id="add-candidate-form" class="space-y-4">
                            <input type="text" id="candidate-name" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5" placeholder="Presenter Name" required>
                            <!-- UPDATED: New session list for Admin "Add Presenter" form -->
                            <select id="candidate-session" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5" required>
                                <option value="" disabled selected>Select Session</option>
                                <option value="Showcase 1 (Poster 1st Session)">Showcase 1 (Poster 1st Session)</option>
                                <option value="Showcase 2 (Oral 1st Session)">Showcase 2 (Oral 1st Session)</option>
                                <option value="Showcase 3 (Poster 2nd Session)">Showcase 3 (Poster 2nd Session)</option>
                                <option value="Showcase 4 (Oral 2nd Session)">Showcase 4 (Oral 2nd Session)</option>
                                <option value="Showcase 5 (Workshop)">Showcase 5 (Workshop)</option>
                            </select>
                            <select id="candidate-category" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5" disabled>
                                <option value="Poster">Poster Presentation</option>
                                <option value="Oral">Oral Presentation</option>
                                <option value="Workshop">Workshop</option>
                            </select>
                            <input type="number" id="candidate-order" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5" placeholder="Order (e.g., 1, 2, 3)" required min="1">
                            <button type="submit" class="w-full text-white bg-indigo-600 hover:bg-indigo-700 focus:ring-4 focus:outline-none focus:ring-indigo-300 font-medium rounded-lg text-sm px-5 py-2.5">Add Presenter</button>
                        </form>
                    </div>
                    
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h2 class="text-2xl font-semibold mb-4">Presenter List (Drag to Rearrange)</h2>
                        <div id="admin-candidate-list" class="space-y-6"></div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h2 class="text-2xl font-semibold mb-4">Judges Online</h2>
                        <div id="judges-online-list" class="space-y-3"></div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-md">
                         <h2 class="text-2xl font-semibold mb-4">System Controls</h2>
                         <div class="space-y-2">
                             <button id="download-pdf-button" class="w-full text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-lg text-sm px-5 py-2.5">Download Results as PDF</button>
                             <button id="reset-scores-button" class="w-full text-white bg-orange-600 hover:bg-orange-700 font-medium rounded-lg text-sm px-5 py-2.5">Reset All Scores Only</button>
                             <button id="reset-all-button" class="w-full text-white bg-red-600 hover:bg-red-700 font-medium rounded-lg text-sm px-5 py-2.5">Reset Everything (Presenters & Scores)</button>
                         </div>
                    </div>
                </div>

                <div class="lg:col-span-2 space-y-6">
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h2 class="text-2xl font-semibold mb-4">Grand Winners & Category Awards</h2>
                        <div id="winners-board" class="space-y-8">
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h2 class="text-2xl font-semibold mb-4">Live Rankings (All Presenters)</h2>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50" id="rankings-header">
                                </thead>
                                <tbody id="rankings-body" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h2 class="text-2xl font-semibold mb-4">Detailed Scores & Feedback</h2>
                        <div id="feedback-details-board" class="space-y-6">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="judge-view" class="view">
             <header class="flex justify-between items-center mb-8">
                <h1 id="judge-header" class="text-4xl font-bold text-gray-900">Judge Panel</h1>
                <div class="flex items-center space-x-4">
                    <p id="current-session-display" class="text-xl font-semibold text-indigo-600"></p>
                    <button id="judge-logout" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Logout</button>
                </div>
            </header>
            
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div id="judge-sidebar-wrapper" class="md:col-span-1 bg-white p-4 rounded-xl shadow-md space-y-4">
                    <div class="space-y-1">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Presenter List</h3>
                        <p class="text-xs text-gray-500 bg-indigo-50 p-2 rounded-md mb-3">
                            Click on any presenter to view or amend their scores before final submission.
                        </p>
                        <div id="judge-sidebar-list" class="space-y-1">
                            <p class="text-gray-500 text-sm">Loading...</p>
                        </div>
                    </div>
                    
                    <div class="border-t pt-4">
                        <button id="final-submit-button" class="w-full text-white bg-green-600 hover:bg-green-700 font-medium rounded-lg text-sm px-5 py-2.5 disabled:opacity-50" disabled>
                            Submit All Scores
                        </button>
                    </div>
                </div>

                <div class="md:col-span-3">
                    <div id="judge-presenter-card" class="bg-white p-8 rounded-xl shadow-2xl">
                        <p class="text-center text-gray-500 text-xl" id="judge-status-message">Loading next presenter...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="confirmation-modal" class="modal-overlay">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-medium leading-6 text-gray-900" id="modal-title">Confirm Action</h3>
            <div class="mt-2"><p class="text-sm text-gray-500" id="modal-message">Are you sure?</p></div>
            <div class="mt-5 sm:mt-6 sm:grid sm:grid-cols-2 sm:gap-3 sm:grid-flow-row-dense">
                <button id="modal-confirm-btn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 sm:col-start-2 sm:text-sm">Confirm</button>
                <button id="modal-cancel-btn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:col-start-1 sm:text-sm">Cancel</button>
            </div>
        </div>
    </div>

    <script type="module">
        document.addEventListener("DOMContentLoaded", () => {
            const { jsPDF } = window.jspdf;

            const firebaseApp = "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
            const firebaseAuth = "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
            const firebaseFirestore = "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

            Promise.all([
                import(firebaseApp),
                import(firebaseAuth),
                import(firebaseFirestore)
            ]).then((modules) => {
                const { initializeApp } = modules[0];
                const { getAuth, signInAnonymously, signInWithCustomToken } = modules[1];
                const { getFirestore, doc, setDoc, addDoc, deleteDoc, onSnapshot, collection, serverTimestamp, writeBatch, getDocs, getDoc, query, where, orderBy } = modules[2];

                const appId = typeof __app_id !== 'undefined' ? __app_id : 'ppkbis-judging-default';
                
                const firebaseConfig = typeof __firebase_config !== 'undefined' 
                    ? JSON.parse(__firebase_config)
                    : {
                        apiKey: "AIzaSyDCTebeG42Vj1G9TRIApiLhwfsxng5mP0Y",
                        authDomain: "ppkbis-shell.firebaseapp.com",
                        projectId: "ppkbis-shell",
                        storageBucket: "ppkbis-shell.firebasestorage.app",
                        messagingSenderId: "942093342515",
                        appId: "1:942093342515:web:29a844b91ba357835a9046",
                        measurementId: "G-M5Q9NCD7JF"
                      };

                const app = initializeApp(firebaseConfig);
                const db = getFirestore(app);
                const auth = getAuth(app);
                
                (async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else { await signInAnonymously(auth); }
                    const userId = auth.currentUser?.uid || `anonymous-${crypto.randomUUID()}`;

                    // UPDATED: New Session-to-Category mapping.
                    const SESSION_CATEGORY_MAP = {
                        'Showcase 1 (Poster 1st Session)': 'Poster',
                        'Showcase 2 (Oral 1st Session)': 'Oral',
                        'Showcase 3 (Poster 2nd Session)': 'Poster',
                        'Showcase 4 (Oral 2nd Session)': 'Oral',
                        'Showcase 5 (Workshop)': 'Workshop'
                    };
                    const CATEGORIES = {
                        'Poster': [
                            { name: 'Content & Relevance', max: 35, desc: 'Clear coverage of 5 sections; relevant to ELT.' },
                            { name: 'Organisation & Clarity', max: 20, desc: 'Logical flow, concise writing, easy to follow.' },
                            { name: 'Visual Design & Layout', max: 20, desc: 'Layout, size compliance, clear fonts, balanced visuals.' },
                            { name: 'Engagement & Communication', max: 25, desc: 'Presenter explains poster confidently & interacts.' }
                        ],
                        'Oral': [
                            { name: 'Content & Relevance', max: 35, desc: 'Clear coverage of 5 sections, relevant to ELT.' },
                            { name: 'Organisation & Clarity', max: 20, desc: 'Logical sequence, smooth flow, well-timed.' },
                            { name: 'Slide Design', max: 15, desc: 'Professional layout, readability, effective visuals.' },
                            { name: 'Delivery & Engagement', max: 30, desc: 'Clear speech, confidence, manages Q&A well, engages audience.' }
                        ],
                        'Workshop': [
                            { name: 'Content & Relevance', max: 35, desc: '5 sections covered, practical & relevant to ELT.' },
                            { name: 'Organisation & Facilitation', max: 20, desc: 'Clear structure, smooth transitions, time control.' },
                            { name: 'Engagement & Interaction', max: 25, desc: 'Active participant involvement, inclusive facilitation.' },
                            { name: 'Resources & Materials', max: 20, desc: 'Quality & usefulness of handouts/slides/materials.' }
                        ]
                    };
                    const CATEGORY_NAMES = Object.keys(CATEGORIES);
                    const FIXED_JUDGE_COUNT = 3;

                    const AWARD_CAPS = {
                        'Poster': { gold: 5, silver: 7 },
                        'Oral': { gold: 2, silver: 5 },
                        'Workshop': { gold: 2, silver: 5 }
                    };

                    let currentUser = null;
                    let unsubscribeCandidates = () => {};
                    let unsubscribeScores = () => {};
                    let unsubscribeFeedbacks = () => {};
                    let unsubscribePresence = () => {};
                    let presenceInterval = null;
                    
                    // Unified state for Admin Dashboard
                    let adminCandidates = [];
                    let adminScores = [];
                    let adminFeedbacks = [];
                    
                    // Judge state variables
                    let currentJudgeSession = null;
                    let allJudgeCandidates = [];
                    let allJudgeScores = {};
                    let isSubmittingScore = false; 
                    let currentPresenterId = null; 

                    const views = { login: document.getElementById('login-view'), admin: document.getElementById('admin-view'), judge: document.getElementById('judge-view') };

                    function showView(viewName) {
                        Object.values(views).forEach(view => view.classList.remove('active'));
                        if (views[viewName]) views[viewName].classList.add('active');
                    }

                    function updateCategoryDropdown(sessionValue) {
                        const category = SESSION_CATEGORY_MAP[sessionValue] || 'Poster';
                        const categorySelect = document.getElementById('candidate-category');
                        if (categorySelect) {
                            categorySelect.value = category;
                        }
                    }
                    
                    const updatePresence = () => {
                        if (!currentUser) return;
                        const presenceRef = doc(db, `artifacts/${appId}/public/data/presence`, currentUser.id);
                        setDoc(presenceRef, { name: currentUser.name, lastSeen: serverTimestamp() })
                            .catch(err => console.error("Could not update presence:", err));
                    };

                    async function handleLogin(e) {
                        e.preventDefault();
                        const username = document.getElementById('username').value.trim();
                        const role = document.getElementById('role').value;
                        const session = document.getElementById('session').value;
                        if (!username) { alert("Please enter your name."); return; }
                        if (role === 'judge' && !session) { alert("Please select a session."); return; }

                        if (role === 'admin') {
                            const password = document.getElementById('password').value;
                            if (password !== 'admin123') {
                                alert('Incorrect admin password.');
                                return;
                            }
                        }
                        
                        currentJudgeSession = role === 'judge' ? session : null;
                        
                        currentUser = { id: `${username.replace(/\s+/g, '-')}-${userId.substring(0,4)}`, name: username, role, session: currentJudgeSession };
                        
                        if (role === 'admin') { 
                            showView('admin'); 
                            initAdminView(); 
                        } else { 
                            document.getElementById('judge-header').textContent = `Judge Panel - ${currentUser.name}`;
                            document.getElementById('current-session-display').textContent = `Session: ${currentJudgeSession}`;
                            await updatePresence();
                            presenceInterval = setInterval(updatePresence, 20000); 
                            showView('judge'); 
                            initJudgeView(); 
                        }
                    }

                    async function handleLogout() {
                        if (currentUser && currentUser.role === 'judge') {
                            clearInterval(presenceInterval);
                            await deleteDoc(doc(db, `artifacts/${appId}/public/data/presence`, currentUser.id));
                        }
                        unsubscribeCandidates();
                        unsubscribeScores();
                        unsubscribeFeedbacks();
                        unsubscribePresence();
                        currentUser = null;
                        currentJudgeSession = null;
                        currentPresenterId = null;
                        document.getElementById('username').value = '';
                        // UPDATED: Reset login dropdown to the first new session name
                        document.getElementById('session').value = 'Showcase 1 (Poster 1st Session)';
                        showView('login');
                    }

                    // --- ADMIN VIEW LOGIC ---
                     function renderOnlineJudges(presenceDocs) {
                         const listEl = document.getElementById('judges-online-list');
                         if(!listEl) return;
                         listEl.innerHTML = '';
                         const now = Date.now();
                         presenceDocs.forEach(docSnap => {
                             const data = docSnap.data();
                             if (data.lastSeen && (now - data.lastSeen.toDate().getTime()) < 30000) { // 30 second threshold
                                 const div = document.createElement('div');
                                 div.className = 'flex items-center bg-gray-100 p-2 rounded-lg';
                                 div.innerHTML = `<span class="online-indicator mr-3"></span><span class="font-medium text-gray-700">${data.name}</span>`;
                                 listEl.appendChild(div);
                             }
                         });
                          if (!listEl.hasChildNodes()) {
                             listEl.innerHTML = '<p class="text-gray-500 text-sm">No judges currently online.</p>';
                         }
                    }

                    function initAdminView() {
                        unsubscribeCandidates = onSnapshot(query(collection(db, `artifacts/${appId}/public/data/candidates`)), async (candidateSnapshot) => {
                            adminCandidates = candidateSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            renderAdminCandidateList(adminCandidates);
                            calculateAndDisplayResults(adminCandidates, adminScores, adminFeedbacks);
                        });

                        unsubscribeScores = onSnapshot(collection(db, `artifacts/${appId}/public/data/scores`), async (scoreSnapshot) => {
                            adminScores = scoreSnapshot.docs.map(d => d.data());
                            calculateAndDisplayResults(adminCandidates, adminScores, adminFeedbacks);
                        });
                        
                        unsubscribeFeedbacks = onSnapshot(collection(db, `artifacts/${appId}/public/data/feedback`), (snapshot) => {
                            adminFeedbacks = snapshot.docs.map(d => d.data());
                            calculateAndDisplayResults(adminCandidates, adminScores, adminFeedbacks);
                        });
                        
                        unsubscribePresence = onSnapshot(collection(db, `artifacts/${appId}/public/data/presence`), (snapshot) => {
                            renderOnlineJudges(snapshot.docs);
                        });
                    }
                    
                    async function handleAddCandidate(e) {
                        e.preventDefault();
                        const candidateNameInput = document.getElementById('candidate-name');
                        const candidateName = candidateNameInput.value.trim();
                        const session = document.getElementById('candidate-session').value;
                        const order = parseInt(document.getElementById('candidate-order').value, 10);
                        
                        if (!candidateName || !session || isNaN(order)) { 
                            alert("Please fill all fields correctly."); 
                            return; 
                        }

                        const category = SESSION_CATEGORY_MAP[session];
                        const orderIndex = order;

                        const existing = adminCandidates.find(c => c.session === session && c.orderIndex === orderIndex);
                        if (existing) {
                            alert(`Order number ${orderIndex} already exists in ${session}. Please use a different number.`);
                            return;
                        }
                        
                        await addDoc(collection(db, `artifacts/${appId}/public/data/candidates`), { 
                            name: candidateName, 
                            session: session,
                            category: category,
                            orderIndex: orderIndex
                        });

                        candidateNameInput.value = '';
                        document.getElementById('candidate-order').value = '';
                    }

                    async function deleteCandidate(candidateId) {
                        if (await showConfirmationModal('Delete Presenter', `This will delete the presenter and ALL associated scores and feedback. Are you sure?`)) {
                            const batch = writeBatch(db);

                            batch.delete(doc(db, `artifacts/${appId}/public/data/candidates`, candidateId));

                            const scoresQuery = query(collection(db, `artifacts/${appId}/public/data/scores`), where("candidateId", "==", candidateId));
                            const scoresSnapshot = await getDocs(scoresQuery);
                            scoresSnapshot.docs.forEach(d => batch.delete(d.ref));

                            const feedbackQuery = query(collection(db, `artifacts/${appId}/public/data/feedback`), where("candidateId", "==", candidateId));
                            const feedbackSnapshot = await getDocs(feedbackQuery);
                            feedbackSnapshot.docs.forEach(d => batch.delete(d.ref));

                            await batch.commit();
                        }
                    }
                    
                    async function handlePresenterReorder(evt) {
                        if (evt.from !== evt.to) { return; } 
                        
                        const listEl = evt.from;
                        const newOrder = Array.from(listEl.children).map(item => item.dataset.id);

                        const batch = writeBatch(db);
                        
                        newOrder.forEach((candidateId, index) => {
                            const newOrderIndex = index + 1;
                            const candidateRef = doc(db, `artifacts/${appId}/public/data/candidates`, candidateId);
                            batch.update(candidateRef, { orderIndex: newOrderIndex });
                        });

                        try {
                            await batch.commit();
                        } catch (error) {
                            console.error("Error committing batch reorder:", error);
                            alert("Failed to save new order. Please try again.");
                        }
                    }

                    function initSortableLists() {
                        document.querySelectorAll('.sortable-session-list').forEach(list => {
                            if (list.sortable) {
                                list.sortable.destroy();
                            }
                            
                            list.sortable = Sortable.create(list, {
                                animation: 150,
                                ghostClass: 'bg-indigo-100',
                                handle: '.drag-handle',
                                group: {
                                    name: 'sessions',
                                    pull: false, 
                                    put: false
                                },
                                onEnd: handlePresenterReorder,
                            });
                        });
                    }
                    
                    function renderAdminCandidateList(candidates) {
                        const listEl = document.getElementById('admin-candidate-list');
                        if(!listEl) return;
                        listEl.innerHTML = '';

                        const sessions = {};
                        Object.keys(SESSION_CATEGORY_MAP).forEach(sessionKey => {
                            sessions[sessionKey] = [];
                        });

                        candidates.forEach(c => {
                            const sessionKey = c.session || 'zz_Unassigned Session';
                            if (!sessions[sessionKey]) {
                                sessions[sessionKey] = [];
                            }
                            sessions[sessionKey].push(c);
                        });

                        const sessionKeys = Object.keys(sessions).sort();

                        if (candidates.length === 0 && sessionKeys.length === 0) {
                            listEl.innerHTML = '<p class="text-gray-500">No presenters added yet.</p>';
                            return;
                        }

                        sessionKeys.forEach(sessionKey => {
                            const displayKey = sessionKey.startsWith('zz_') ? sessionKey.substring(3) : sessionKey;
                            
                            const sessionGroup = document.createElement('div');
                            sessionGroup.className = 'mb-4 border-b border-indigo-200 pb-2';
                            sessionGroup.innerHTML = `<h4 class="text-lg font-semibold text-indigo-700 mb-2">${displayKey}</h4>`;
                            
                            const ulList = document.createElement('ul');
                            ulList.className = 'space-y-1 sortable-session-list';
                            ulList.id = `sortable-${sessionKey.replace(/\W/g, '-')}`;
                            ulList.dataset.session = sessionKey;

                            if (sessions[sessionKey].length > 0) {
                                sessions[sessionKey].sort((a,b)=> (a.orderIndex || 0) - (b.orderIndex || 0)).forEach(c => {
                                    const li = document.createElement('li');
                                    li.className = `presenter-item bg-gray-50 hover:bg-gray-100 rounded-lg shadow-sm`;
                                    li.dataset.id = c.id;
                                    li.dataset.session = c.session;
    
                                    li.innerHTML = `<div class="flex justify-between items-center p-2">
                                        <div class="flex items-center space-x-3 drag-handle text-gray-400 hover:text-gray-600 cursor-grab">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                                <path d="M10 3a1 1 0 011 1v2a1 1 0 11-2 0V4a1 1 0 011-1zM7 7a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1zM4 11a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM7 15a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1zM10 18a1 1 0 011-1v2a1 1 0 11-2 0v-2a1 1 0 011 1z"/>
                                            </svg>
                                            <span class="text-sm font-medium text-gray-900">${c.orderIndex || '-'}. ${c.name}</span>
                                            <span class="ml-2 text-xs text-gray-600 bg-gray-200 px-2 py-1 rounded-full">${c.category}</span>
                                        </div>
                                        <button data-id="${c.id}" class="delete-candidate-btn text-red-500 hover:text-red-700 text-xs font-bold">DELETE</button>
                                    </div>`;
                                    
                                    ulList.appendChild(li);
                                });
                            } else {
                                ulList.innerHTML = `<p class="text-sm text-gray-400 italic px-2">No presenters assigned to this session yet.</p>`;
                            }

                            sessionGroup.appendChild(ulList);
                            listEl.appendChild(sessionGroup);
                        });

                        initSortableLists();

                        document.querySelectorAll('.delete-candidate-btn').forEach(btn => btn.onclick = (e) => {
                            deleteCandidate(e.target.dataset.id);
                        });
                    }
                    
                    /**
                     * A reusable function to determine winners based on ranking caps.
                     * This ensures consistency between the live dashboard and the PDF report.
                     */
                    function calculateWinners(fullyJudgedResults) {
                        const categoryWinners = {};
                        const winnerMap = new Map();

                        CATEGORY_NAMES.forEach(cat => {
                            const catResults = fullyJudgedResults.filter(r => r.category === cat).sort((a, b) => b.average - a.average);
                            const caps = AWARD_CAPS[cat];

                            const goldWinners = catResults.slice(0, caps.gold);
                            const goldWinnerIds = new Set(goldWinners.map(w => w.id));

                            const remainingForSilver = catResults.filter(r => !goldWinnerIds.has(r.id));
                            const silverWinners = remainingForSilver.slice(0, caps.silver);
                            const silverWinnerIds = new Set(silverWinners.map(w => w.id));

                            const bronzeWinners = catResults.filter(r => {
                                return !goldWinnerIds.has(r.id) && !silverWinnerIds.has(r.id) && r.average >= 55;
                            });

                            categoryWinners[cat] = { gold: goldWinners, silver: silverWinners, bronze: bronzeWinners };

                            goldWinners.forEach(r => winnerMap.set(r.id, { level: 'Gold', class: 'bg-yellow-400 text-white' }));
                            silverWinners.forEach(r => winnerMap.set(r.id, { level: 'Silver', class: 'bg-gray-400 text-white' }));
                            bronzeWinners.forEach(r => winnerMap.set(r.id, { level: 'Bronze', class: 'bg-yellow-600 text-white' }));
                        });

                        return { categoryWinners, winnerMap };
                    }

                    function calculateAndDisplayResults(candidates, scores, feedbacks) {
                        if (!candidates || !scores || !feedbacks) return;
                        
                        const judges = [...new Set(scores.map(s => s.judgeName))].sort();
                        
                        let results = candidates.map(c => {
                            const scoresByJudge = {};
                            judges.forEach(j => {
                                const judgeScores = scores.filter(s => s.candidateId === c.id && s.judgeName === j);
                                scoresByJudge[j] = judgeScores.reduce((sum, s) => sum + (s.score || 0), 0);
                            });
                            const totalScores = Object.values(scoresByJudge).filter(s => s > 0);
                            const judgeCount = totalScores.length;
                            const average = judgeCount > 0 ? totalScores.reduce((a, b) => a + b, 0) / judgeCount : 0;
                            return { ...c, scoresByJudge, average: parseFloat(average.toFixed(2)), judgeCount, award: '-' };
                        });

                        const fullyJudged = results.filter(r => r.judgeCount === FIXED_JUDGE_COUNT);
                        
                        // Use the consistent winner calculation function
                        const { categoryWinners, winnerMap } = calculateWinners(fullyJudged);
                        
                        results.forEach(r => {
                            if(winnerMap.has(r.id)) r.award = winnerMap.get(r.id).level;
                        });

                        const rankings = results.sort((a, b) => {
                             if (b.average !== a.average) return b.average - a.average;
                             if (a.session !== b.session) return (a.session || "").localeCompare(b.session || "");
                             return (a.orderIndex || 0) - (b.orderIndex || 0);
                        });

                        // --- Render Winner Board (Real-Time Update) ---
                        const winnersBoard = document.getElementById('winners-board');
                        if(!winnersBoard) return;
                        winnersBoard.innerHTML = '';
                        
                        // 1. Grand Winner Section
                        const overallRanking = fullyJudged.sort((a,b) => b.average - a.average);
                        const grandWinners = overallRanking.slice(0, 3);

                        let grandWinnerHTML = `<div class="text-center p-6 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl shadow-lg mb-8">
                            <h3 class="text-2xl font-bold text-white uppercase tracking-wider">Top 3 Grand Winners (Highest Average Score)</h3>`;
                        if (grandWinners.length > 0) {
                             grandWinnerHTML += `<div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4 text-white">`;
                             const places = ['1st Place', '2nd Place', '3rd Place'];
                             grandWinners.forEach((winner, index) => {
                                 grandWinnerHTML += `<div>
                                     <p class="text-lg font-bold">${places[index]}</p>
                                     <p class="text-2xl font-extrabold">${winner.name}</p>
                                     <p class="text-md font-medium text-indigo-200">(${winner.category}) - ${winner.average.toFixed(2)}</p>
                                 </div>`;
                             });
                             grandWinnerHTML += `</div>`;
                        } else {
                            grandWinnerHTML += `<p class="text-xl font-semibold text-white mt-2">- Awaiting ${FIXED_JUDGE_COUNT} scores -</p>`;
                        }
                        grandWinnerHTML += `</div>`;
                        winnersBoard.innerHTML += grandWinnerHTML;
                        
                        // 2. Category Winners Section (Real-Time Update)
                        winnersBoard.innerHTML += `<h3 class="text-xl font-bold text-gray-900 mb-4">Winners by Category (Minimum ${FIXED_JUDGE_COUNT} Judges)</h3>`;
                        
                        const categoryCardContainer = document.createElement('div');
                        categoryCardContainer.className = 'grid grid-cols-1 md:grid-cols-3 gap-4';

                        CATEGORY_NAMES.forEach(cat => {
                            const catData = categoryWinners[cat];
                            const caps = AWARD_CAPS[cat];
                            
                            const renderCategoryTier = (title, winners, colorClass) => {
                                let html = `<div class="mt-2"><p class="font-medium text-sm text-gray-700">${title} (${winners.length}):</p>`;
                                if (winners.length > 0) {
                                    html += `<div class="flex flex-wrap gap-2 pt-1">` + winners.map(w =>
                                        `<span class="px-3 py-1 text-xs font-semibold rounded-full ${colorClass} text-white">${w.name} (${w.average.toFixed(2)})</span>`
                                    ).join('') + `</div>`;
                                } else {
                                    html += `<p class="text-xs text-gray-500 italic">None finalized.</p>`;
                                }
                                html += `</div>`;
                                return html;
                            };

                            let categoryHTML = `<div class="bg-gray-100 p-4 rounded-lg shadow-sm h-full flex flex-col">
                                <h4 class="text-xl font-bold text-indigo-700 mb-3 border-b pb-2">${cat}</h4>
                                ${renderCategoryTier(`Gold (Top ${caps.gold})`, catData.gold, 'bg-yellow-600')}
                                ${renderCategoryTier(`Silver (Next ${caps.silver})`, catData.silver, 'bg-gray-500')}
                                ${renderCategoryTier('Bronze (>=55)', catData.bronze, 'bg-amber-700')}
                            </div>`;
                            
                            categoryCardContainer.innerHTML += categoryHTML;
                        });
                        winnersBoard.appendChild(categoryCardContainer);


                        // --- Render Rankings Table (Real-Time Update) ---
                        const tableHeader = document.getElementById('rankings-header');
                        if(!tableHeader) return;
                        tableHeader.innerHTML = `<tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Presenter</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Session/Category</th>
                            ${judges.map(j => `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${j}</th>`).join('')}
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Judges Submitted</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Average</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Award</th>
                        </tr>`;
                        
                        const rankingsBody = document.getElementById('rankings-body');
                        if(!rankingsBody) return;
                        rankingsBody.innerHTML = '';
                        rankings.forEach(r => {
                            const awardInfo = winnerMap.get(r.id);
                            let awardClass = '';
                            if (awardInfo) {
                                awardClass = awardInfo.level === 'Gold' ? 'bg-yellow-400 text-white' : 
                                             (awardInfo.level === 'Silver' ? 'bg-gray-400 text-white' : 'bg-yellow-600 text-white');
                            }
                            
                            const row = document.createElement('tr');
                            row.innerHTML = `<td class="px-6 py-4 whitespace-nowrap font-medium">${r.orderIndex ? `${r.orderIndex}. ` : ''}${r.name}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${r.session || r.category}</td>
                                ${judges.map(j => `<td class="px-6 py-4 whitespace-nowrap text-sm">${r.scoresByJudge[j] || '-'}</td>`).join('')}
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 font-medium">${r.judgeCount} / ${FIXED_JUDGE_COUNT}</td>
                                <td class="px-6 py-4 whitespace-nowrap font-bold">${r.average.toFixed(2)}</td>
                                <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${awardClass}">${r.award}</span></td>`;
                            rankingsBody.appendChild(row);
                        });

                        // --- Render Detailed Feedback Board (Real-Time Update) ---
                        // REFINED: This section is now organized by category.
                        const feedbackBoard = document.getElementById('feedback-details-board');
                        if(!feedbackBoard) return;
                        feedbackBoard.innerHTML = '';

                        const judgeMap = new Map();
                        scores.forEach(s => { if (!judgeMap.has(s.judgeId)) judgeMap.set(s.judgeId, s.judgeName) });

                        const augmentedFeedbacks = feedbacks.map(f => ({ ...f, judgeName: judgeMap.get(f.judgeId) || 'Unknown' }));

                        if (rankings.length === 0) {
                            feedbackBoard.innerHTML = '<p class="text-gray-500">No presenters have been scored yet.</p>';
                            return;
                        } 

                        CATEGORY_NAMES.forEach(category => {
                            const categorySection = document.createElement('div');
                            categorySection.className = 'mb-8';
                            
                            const presentersInCategory = rankings
                                .filter(r => r.category === category)
                                .sort((a,b) => (a.session||"").localeCompare(b.session||"") || (a.orderIndex||0) - (b.orderIndex||0));

                            let categoryHTML = `<h3 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">${category} Presentations</h3>`;

                            if (presentersInCategory.length > 0) {
                                presentersInCategory.forEach(candidate => {
                                    const feedbackForCandidate = augmentedFeedbacks.filter(f => f.candidateId === candidate.id);
                                    const judgesWhoScored = Object.keys(candidate.scoresByJudge).filter(j => (candidate.scoresByJudge[j] || 0) > 0);

                                    categoryHTML += `<div class="bg-gray-50 p-4 rounded-lg mb-4">
                                        <h4 class="text-lg font-bold text-indigo-700">${candidate.orderIndex ? `${candidate.orderIndex}. ` : ''}${candidate.name} <span class="text-sm font-medium text-gray-500">- ${candidate.session}</span></h4>
                                        <div class="mt-3 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">`;

                                    if (judgesWhoScored.length > 0) {
                                        judgesWhoScored.forEach(judgeName => {
                                            const judgeFeedback = feedbackForCandidate.find(f => f.judgeName === judgeName);
                                            const feedbackText = (judgeFeedback && judgeFeedback.feedbackText) ? judgeFeedback.feedbackText : 'No feedback submitted.';
                                            
                                            categoryHTML += `<div class="bg-white p-3 rounded-md shadow-sm">
                                                <div class="flex justify-between items-center border-b pb-2 mb-2">
                                                    <p class="font-semibold text-gray-800">${judgeName}</p>
                                                    <p class="font-bold text-gray-600">Score: ${candidate.scoresByJudge[judgeName]}</p>
                                                </div>
                                                <p class="text-sm text-gray-600 italic">"${feedbackText}"</p>
                                            </div>`;
                                        });
                                    } else {
                                        categoryHTML += `<p class="text-sm text-gray-500 col-span-full">No scores or feedback submitted yet for this presenter.</p>`;
                                    }
                                    categoryHTML += `</div></div>`;
                                });
                            } else {
                                categoryHTML += `<p class="text-gray-500 italic">No presenters have been scored in the ${category} category yet.</p>`;
                            }

                            categorySection.innerHTML = categoryHTML;
                            feedbackBoard.appendChild(categorySection);
                        });
                    }
                    
                    async function resetScores() {
                         if (await showConfirmationModal('Reset All Scores Only?', 'This will delete ALL scores and feedback but will keep the list of presenters. This action is irreversible.')) {
                             const scoresQuery = query(collection(db, `artifacts/${appId}/public/data/scores`));
                             const feedbackQuery = query(collection(db, `artifacts/${appId}/public/data/feedback`));

                             const [scoresSnapshot, feedbackSnapshot] = await Promise.all([getDocs(scoresQuery), getDocs(feedbackQuery)]);

                             const batch = writeBatch(db);
                             scoresSnapshot.docs.forEach(d => batch.delete(d.ref));
                             feedbackSnapshot.docs.forEach(d => batch.delete(d.ref));
                             await batch.commit();
                             alert('All scores and feedback have been reset.');
                           }
                    }
                    
                    async function handleResetEverything() {
                        if (await showConfirmationModal('RESET EVERYTHING?', 'This will delete ALL presenters, scores, and feedback. This action is irreversible and will completely wipe the event data.')) {
                            const [candidatesSnapshot, scoresSnapshot, feedbackSnapshot] = await Promise.all([
                                getDocs(query(collection(db, `artifacts/${appId}/public/data/candidates`))),
                                getDocs(query(collection(db, `artifacts/${appId}/public/data/scores`))),
                                getDocs(query(collection(db, `artifacts/${appId}/public/data/feedback`)))
                            ]);

                            const batch = writeBatch(db);
                            candidatesSnapshot.docs.forEach(d => batch.delete(d.ref));
                            scoresSnapshot.docs.forEach(d => batch.delete(d.ref));
                            feedbackSnapshot.docs.forEach(d => batch.delete(d.ref));
                            await batch.commit();
                            alert('The entire event has been reset.');
                        }
                    }

                    // --- JUDGE VIEW LOGIC ---

                    function initJudgeView() {
                        const candidatesQuery = query(collection(db, `artifacts/${appId}/public/data/candidates`), where("session", "==", currentJudgeSession));
                        unsubscribeCandidates = onSnapshot(candidatesQuery, (snapshot) => {
                            allJudgeCandidates = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            allJudgeCandidates.sort((a,b) => (a.orderIndex || 0) - (b.orderIndex || 0));

                            if (allJudgeCandidates.length > 0 && !currentPresenterId) {
                                currentPresenterId = allJudgeCandidates[0].id;
                            }
                            renderJudgeSidebar();
                            renderCurrentPresenterCard();
                            checkFinalSubmissionStatus();
                        });
                    }

                    function renderJudgeSidebar() {
                        const listEl = document.getElementById('judge-sidebar-list');
                        if (!listEl) return;
                        listEl.innerHTML = '';

                        if (allJudgeCandidates.length === 0) {
                            listEl.innerHTML = `<p class="text-gray-500 text-sm">No presenters in this session.</p>`;
                            return;
                        }

                        allJudgeCandidates.forEach(c => {
                            const div = document.createElement('div');
                            div.className = `sidebar-item p-3 rounded-md flex justify-between items-center ${currentPresenterId === c.id ? 'active-card' : ''}`;
                            div.dataset.id = c.id;
                            div.innerHTML = `<span>${c.orderIndex}. ${c.name}</span>
                                <span class="score-status-indicator" data-candidate-id="${c.id}"></span>`;
                            div.onclick = () => {
                                currentPresenterId = c.id;
                                renderJudgeSidebar();
                                renderCurrentPresenterCard();
                            };
                            listEl.appendChild(div);
                        });
                        updateAllScoreStatusIndicators();
                    }

                    function updateAllScoreStatusIndicators() {
                        allJudgeCandidates.forEach(c => {
                             updateScoreStatusIndicator(c.id);
                        });
                    }

                    function updateScoreStatusIndicator(candidateId) {
                        const indicator = document.querySelector(`.score-status-indicator[data-candidate-id="${candidateId}"]`);
                        if (!indicator) return;

                        const candidate = allJudgeCandidates.find(c => c.id === candidateId);
                        if (!candidate) return;

                        const scores = allJudgeScores[candidateId];
                        const criteria = CATEGORIES[candidate.category];
                        const isScored = scores && criteria.every(crit => scores[crit.name] !== null && scores[crit.name] !== undefined);
                        
                        indicator.innerHTML = isScored 
                            ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>`
                            : '';
                    }

                    function renderCurrentPresenterCard() {
                        const cardContainer = document.getElementById('judge-presenter-card');
                        if (!cardContainer) return;

                        if (!currentPresenterId || allJudgeCandidates.length === 0) {
                            cardContainer.innerHTML = `<p class="text-center text-gray-500 text-xl" id="judge-status-message">Select a presenter from the list to begin scoring.</p>`;
                            return;
                        }

                        const presenter = allJudgeCandidates.find(p => p.id === currentPresenterId);
                        if (!presenter) {
                             cardContainer.innerHTML = `<p class="text-center text-gray-500 text-xl">Error: Presenter not found.</p>`;
                             return;
                        }

                        const criteria = CATEGORIES[presenter.category];
                        const maxTotal = criteria.reduce((sum, crit) => sum + crit.max, 0);

                        const criteriaHTML = criteria.map(crit => {
                            const fieldId = `score-${presenter.id}-${crit.name.replace(/\W/g, '-')}`;
                            const existingScore = (allJudgeScores[presenter.id] && (allJudgeScores[presenter.id][crit.name] !== null && allJudgeScores[presenter.id][crit.name] !== undefined)) ? allJudgeScores[presenter.id][crit.name] : '';
                            return `<div class="space-y-1">
                                <div class="flex justify-between items-center">
                                    <label for="${fieldId}" class="text-sm font-medium text-gray-800">${crit.name} (Max: ${crit.max})</label>
                                    <input type="number" id="${fieldId}" name="${crit.name}" value="${existingScore}" data-max="${crit.max}" min="0" max="${crit.max}" class="score-input w-20 text-center bg-gray-50 border border-gray-300 text-sm rounded-lg p-1.5" required>
                                </div>
                                <p class="text-xs text-gray-500">${crit.desc}</p>
                            </div>`;
                        }).join('');
                        
                        const existingFeedback = (allJudgeScores[presenter.id] && allJudgeScores[presenter.id].feedbackText) || '';

                        cardContainer.innerHTML = `
                            <h2 class="text-3xl font-bold mb-1">${presenter.orderIndex}. ${presenter.name}</h2>
                            <p class="text-md text-gray-500 mb-6">${presenter.session}</p>
                            <form data-candidate-id="${presenter.id}" class="candidate-score-form space-y-4">
                                <div class="space-y-4">${criteriaHTML}</div>
                                <div class="text-right font-bold text-lg pt-4 border-t">Total: <span class="total-score">0</span> / ${maxTotal}</div>
                                <div class="mt-4 pt-4 border-t">
                                    <label for="feedback-${presenter.id}" class="block text-sm font-medium text-gray-700 mb-1">Feedback</label>
                                    <textarea id="feedback-${presenter.id}" rows="3" class="w-full bg-gray-50 border border-gray-300 text-sm rounded-lg p-2">${existingFeedback}</textarea>
                                </div>
                                <button type="submit" class="w-full mt-4 text-white bg-indigo-600 hover:bg-indigo-700 font-medium rounded-lg text-sm px-5 py-2.5">Save & Next</button>
                            </form>
                        `;

                        const form = cardContainer.querySelector('form');
                        updateLiveTotal(form); // Initial calculation
                        form.addEventListener('input', (e) => {
                             if (e.target.classList.contains('score-input')) {
                                 const input = e.target;
                                 const max = parseInt(input.dataset.max, 10);
                                 if (parseInt(input.value) > max) input.value = max;
                                 if (parseInt(input.value) < 0) input.value = 0;
                                 updateLiveTotal(form);
                             }
                        });
                        form.addEventListener('submit', handleScoreSave);
                    }
                    
                    function updateLiveTotal(form) {
                          let total = 0;
                          form.querySelectorAll('.score-input').forEach(i => { total += parseInt(i.value, 10) || 0; });
                          form.querySelector('.total-score').textContent = total;
                    }
                    
                    async function handleScoreSave(e) {
                        e.preventDefault();
                        if (isSubmittingScore) return;
                        
                        const form = e.target;
                        const candidateId = form.dataset.candidateId;
                        
                        let isComplete = true;
                        
                        const batch = writeBatch(db);
                        const candidate = allJudgeCandidates.find(c => c.id === candidateId);
                        if (!candidate) return;

                        const criteria = CATEGORIES[candidate.category];
                        criteria.forEach(crit => {
                             const input = form.querySelector(`[name="${crit.name}"]`);
                             const score = parseInt(input.value, 10);
                             if (isNaN(score)) {
                                 isComplete = false;
                             } else {
                                 const scoreId = `${candidateId}-${currentUser.id}-${crit.name.replace(/\W/g, '-')}`;
                                 const scoreRef = doc(db, `artifacts/${appId}/public/data/scores`, scoreId);
                                 batch.set(scoreRef, { candidateId, judgeId: currentUser.id, judgeName: currentUser.name, category: crit.name, score: score });
                             }
                        });


                        if (!isComplete) {
                            alert('Please fill in all score fields for this presenter before moving to the next.');
                            return;
                        }

                        const feedbackText = form.querySelector('textarea').value;
                        const feedbackId = `${candidateId}_${currentUser.id}`;
                        const feedbackRef = doc(db, `artifacts/${appId}/public/data/feedback`, feedbackId);
                        batch.set(feedbackRef, { candidateId, judgeId: currentUser.id, feedbackText: feedbackText });
                        
                        try {
                            await batch.commit();
                            updatePresence(); // Refresh online status on activity
                            
                            // Immediately update local state
                            const scores = {};
                             criteria.forEach(crit => {
                                 const input = form.querySelector(`[name="${crit.name}"]`);
                                 scores[crit.name] = parseInt(input.value, 10);
                             });
                            scores.feedbackText = feedbackText;
                            allJudgeScores[candidateId] = scores;


                            // Move to the next presenter
                            const currentIndex = allJudgeCandidates.findIndex(c => c.id === candidateId);
                            if (currentIndex < allJudgeCandidates.length - 1) {
                                currentPresenterId = allJudgeCandidates[currentIndex + 1].id;
                                renderCurrentPresenterCard();
                            } else {
                                alert('All presenters for this session have been scored. Review your scores and then click "Submit All Scores".');
                            }
                            renderJudgeSidebar();
                            checkFinalSubmissionStatus();

                        } catch(err) {
                            console.error("Error saving score:", err);
                            alert("There was an error saving the score. Please try again.");
                        }
                    }
                    
                    function checkFinalSubmissionStatus() {
                        const submitButton = document.getElementById('final-submit-button');
                        if(!submitButton) return;

                        const allScored = allJudgeCandidates.every(c => {
                           const scores = allJudgeScores[c.id];
                           if (!scores) return false;
                           const criteria = CATEGORIES[c.category];
                           return criteria.every(crit => scores[crit.name] !== null && scores[crit.name] !== undefined);
                        });

                        submitButton.disabled = !allScored;
                    }
                    
                    async function handleFinalSubmit() {
                        const confirmationMessage = `You are confirming that all scores for this session are final. This action cannot be undone. Are you sure?`;
                        if (await showConfirmationModal('Final Submission', confirmationMessage)) {
                            const submitButton = document.getElementById('final-submit-button');
                            submitButton.textContent = 'SUBMITTED';
                            submitButton.disabled = true;
                            submitButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                            submitButton.classList.add('bg-gray-400', 'cursor-not-allowed');

                             document.getElementById('judge-presenter-card').innerHTML = `<p class="text-center text-2xl text-green-600 font-bold">Thank you! Your scores for this session have been submitted.</p>`;
                             // Optionally disable sidebar clicks
                             document.querySelectorAll('.sidebar-item').forEach(item => item.style.pointerEvents = 'none');
                        }
                    }

                    function showConfirmationModal(title, message) {
                        return new Promise((resolve) => {
                            const modal = document.getElementById('confirmation-modal');
                            modal.querySelector('#modal-title').textContent = title;
                            modal.querySelector('#modal-message').textContent = message;
                            modal.classList.add('active');
                            const confirmBtn = modal.querySelector('#modal-confirm-btn');
                            const cancelBtn = modal.querySelector('#modal-cancel-btn');
                            const close = (result) => {
                                modal.classList.remove('active');
                                confirmBtn.replaceWith(confirmBtn.cloneNode(true));
                                cancelBtn.replaceWith(cancelBtn.cloneNode(true));
                                resolve(result);
                            };
                            modal.querySelector('#modal-confirm-btn').onclick = () => close(true);
                            modal.querySelector('#modal-cancel-btn').onclick = () => close(false);
                        });
                    }
                    
                    function generatePDF() {
                        const { jsPDF } = window.jspdf;
                        const doc = new jsPDF();
                        let y = 15;

                        doc.setFontSize(22);
                        doc.text("PPKBIS Showcase - Official Results", 105, y, { align: 'center' });
                        y += 10;
                        doc.setFontSize(12);
                        doc.text(new Date().toLocaleString(), 105, y, { align: 'center' });
                        y += 15;
                        
                        // --- Data processing for PDF ---
                        const results = adminCandidates.map(c => {
                             const scoresByJudge = {};
                             const judges = [...new Set(adminScores.map(s => s.judgeName))];
                             judges.forEach(j => {
                                 const judgeScores = adminScores.filter(s => s.candidateId === c.id && s.judgeName === j);
                                 scoresByJudge[j] = judgeScores.reduce((sum, s) => sum + (s.score || 0), 0);
                             });
                             const totalScores = Object.values(scoresByJudge).filter(s => s > 0);
                             const judgeCount = totalScores.length;
                             const average = judgeCount > 0 ? totalScores.reduce((a, b) => a + b, 0) / judgeCount : 0;
                             return { ...c, scoresByJudge, average, judgeCount };
                        });
                        const fullyJudged = results.filter(r => r.judgeCount === FIXED_JUDGE_COUNT);

                        const { categoryWinners } = calculateWinners(fullyJudged);
                        const grandWinners = [...fullyJudged].sort((a,b) => b.average - a.average).slice(0, 3);


                        // --- Winners Summary Section ---
                        doc.setFontSize(16);
                        doc.text("Winners Summary", 14, y);
                        y += 8;

                        doc.setFontSize(12);
                        doc.text("Top 3 Grand Winners:", 14, y);
                        y += 6;
                        doc.setFontSize(10);
                        if (grandWinners.length > 0) {
                            grandWinners.forEach((winner, index) => {
                                doc.text(`${index + 1}. ${winner.name} (${winner.category}) - Avg: ${winner.average.toFixed(2)}`, 18, y);
                                y += 6;
                            });
                        } else {
                            doc.text("N/A - Awaiting scores from all judges.", 18, y);
                            y += 6;
                        }
                        y += 4;
                        
                        Object.keys(categoryWinners).forEach(cat => {
                            if (y > 270) { doc.addPage(); y = 15; }
                            const winners = categoryWinners[cat];
                            doc.setFontSize(12);
                            doc.text(`${cat} Category Winners:`, 14, y);
                            y += 6;
                            doc.setFontSize(10);
                            doc.text(`Gold: ${winners.gold.map(w => w.name).join(', ') || 'None'}`, 18, y);
                            y += 6;
                            doc.text(`Silver: ${winners.silver.map(w => w.name).join(', ') || 'None'}`, 18, y);
                            y += 6;
                            doc.text(`Bronze: ${winners.bronze.map(w => w.name).join(', ') || 'None'}`, 18, y);
                            y += 10;
                        });

                        // --- Rankings Table Section ---
                        doc.addPage();
                        y = 15;
                        doc.setFontSize(16);
                        doc.text("Overall Rankings", 14, y);
                        y += 8;
                        
                        const allJudges = [...new Set(adminScores.map(s => s.judgeName))].sort();
                        const { winnerMap } = calculateWinners(fullyJudged); // Recalculate to get the map

                        const head = [['#', 'Presenter', 'Session', ...allJudges, 'Avg.', 'Award']];
                        const body = results.sort((a,b) => b.average - a.average).map(r => {
                            const award = winnerMap.get(r.id)?.level || '-';
                            return [
                                r.orderIndex,
                                r.name,
                                r.session,
                                ...allJudges.map(j => r.scoresByJudge[j] || '-'),
                                r.average.toFixed(2),
                                award
                            ];
                        });

                        doc.autoTable({ startY: y, head, body });
                        
                        // --- Feedback Section ---
                        doc.addPage();
                        y = 15;
                        doc.setFontSize(16);
                        doc.text("Detailed Feedback", 14, y);
                        y+= 8;
                        
                        adminCandidates.sort((a,b) => (a.session||"").localeCompare(b.session||"") || (a.orderIndex||0) - (b.orderIndex||0)).forEach(c => {
                           const feedbacksForCandidate = adminFeedbacks.filter(f => f.candidateId === c.id);
                           if (y > 270) {
                               doc.addPage();
                               y = 15;
                           }
                           doc.setFontSize(12);
                           doc.text(`${c.orderIndex}. ${c.name} (${c.session})`, 14, y);
                           y += 6;
                           doc.setFontSize(10);
                           if (feedbacksForCandidate.length > 0) {
                               feedbacksForCandidate.forEach(f => {
                                   if (y > 280) { doc.addPage(); y = 15; }
                                   const judgeName = [...new Set(adminScores.filter(s => s.judgeId === f.judgeId).map(s => s.judgeName))][0] || 'Unknown Judge';
                                   const textLines = doc.splitTextToSize(`${judgeName}: ${f.feedbackText || 'No feedback submitted.'}`, 170);
                                   doc.text(textLines, 18, y);
                                   y += (textLines.length * 4) + 2;
                               });
                           } else {
                               doc.text(`No feedback submitted for this presenter.`, 18, y);
                               y+=5;
                           }
                           y+=4;
                        });


                        doc.save('PPKBIS_Showcase_Results.pdf');
                    }
                    
                    // --- Initial Event Listeners ---
                    document.getElementById('login-form').addEventListener('submit', handleLogin);
                    document.getElementById('role').addEventListener('change', (e) => {
                        const passwordField = document.getElementById('admin-password-field');
                        passwordField.style.display = e.target.value === 'admin' ? 'block' : 'none';
                        document.getElementById('session-field').style.display = e.target.value === 'judge' ? 'block' : 'none';
                    });
                    
                    const candidateSessionSelect = document.getElementById('candidate-session');
                    if(candidateSessionSelect) {
                        candidateSessionSelect.addEventListener('change', (e) => {
                            updateCategoryDropdown(e.target.value);
                        });
                        // Initialize based on default or first value
                        if(candidateSessionSelect.value) {
                           updateCategoryDropdown(candidateSessionSelect.value);
                        }
                    }

                    document.getElementById('add-candidate-form').addEventListener('submit', handleAddCandidate);
                    document.getElementById('reset-scores-button').addEventListener('click', resetScores);
                    document.getElementById('reset-all-button').addEventListener('click', handleResetEverything);
                    document.getElementById('download-pdf-button').addEventListener('click', generatePDF);
                    document.getElementById('admin-logout').addEventListener('click', handleLogout);
                    document.getElementById('judge-logout').addEventListener('click', handleLogout);
                    
                    const finalSubmitBtn = document.getElementById('final-submit-button');
                    if(finalSubmitBtn) finalSubmitBtn.addEventListener('click', handleFinalSubmit);
                    
                    showView('login');
                })();
            });
        });
    </script>
</body>
</html>

